psimkins/NodeExpress:
  # Distelli Manifest example

  PreBuild:
    - echo "---Preparing for Build---"
    - set +e; source /etc/profile; set -e
    - nvm install v4.2.1
    
  Build:
    - echo "---Building---"
    - npm install
    - mv node_modules/newrelic/newrelic.js .
    - sed -i "s|license key here|$NR_INSTALL_KEY|g" newrelic.js
    - sed -i "s|My Application|$NR_APP_NAME|g" newrelic.js
    - echo "--Testing--"
    - npm test

  PkgInclude:
    - '*'

  PreInstall:
    - echo "---Begining PreInstall---"
    - echo "--Installing deploy dependencies--"
    - echo "-Updating apt-get-"
    - sudo apt-get -y update
    - echo "-Installing nvm pre-requisites-"
    - sudo apt-get -y install build-essential libssl-dev curl
    - echo "-Installing nvm-"
    - curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.26.0/install.sh | bash
    - set +e; source ~/.nvm/nvm.sh; set -e
    - echo "-Installing nodejs-"
    - nvm install v4.2.1
    - curl -H "x-api-key:d837a39d074eb7a6d61c827bd24b8817c5cd2c9f40284c9" -d "deployment[application_id]=12785375" -d "deployment[description]=This deployment by Distelli" -d "deployment[revision]=$NR_APP_NAME" -d "deployment[changelog]=$NR_APP_NAME" -d "deployment[user]=Peter Simkins" https://api.newrelic.com/deployments.xml | bash

  InstallTemplates:
    - "views/index.jade"

  Env:
    - DISTELLI_INSTALLVIEW: "templates/notset.json"
    - PORT: "8000"
    
  Exec:
    - set +e; source ~/.nvm/nvm.sh; set -e
    - nvm use v4.2.1
    - node app.js
